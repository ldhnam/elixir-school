<!DOCTYPE html>

<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link href="http://gmpg.org/xfn/11" rel="profile">

  <meta name="description" content="Giáo trình cho ngôn ngữ lập trình Elixir">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="https://elixirschool.com/vi/lessons/specifics/plug/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="
  Plug &middot; Elixir School

">
  <meta property="og:description" content="Giáo trình cho ngôn ngữ lập trình Elixir">
  <meta property="og:image" content="https://elixirschool.com/assets/fb_share.jpg">

  <title>
    
  Plug &middot; Elixir School


  </title>

  <!-- CSS -->
  <link type="text/css" rel="stylesheet" href="/assets/app.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>

</head>


  
  <body class="theme-custom-purple ">
    <a id="github_ribbon" href="https://github.com/doomspork/elixir_school"><img src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Elixir School
        </a>
      </h1>
      <p class="lead">Giáo trình cho ngôn ngữ lập trình Elixir</p>
    </div>

    <nav class="sidebar-nav">
      
      
        
        
        
        
          <div class="sidebar-nav-group basics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Cơ bản</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/vi/lessons/basics/basics/">Cơ bản</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/vi/lessons/basics/collections/">Các tập dữ liệu</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/vi/lessons/basics/enum/">Enum</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/vi/lessons/basics/pattern-matching/">Pattern matching (so trùng mẫu)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/vi/lessons/basics/control-structures/">Cấu trúc điều khiển</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/vi/lessons/basics/functions/">Hàm</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson " href="/vi/lessons/basics/pipe-operator/">Pipe Operator</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/vi/lessons/basics/modules/">Modules</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/vi/lessons/basics/mix/">Mix</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/vi/lessons/basics/sigils/">Sigils</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/vi/lessons/basics/documentation/">Documentation</a>
                </div>
              
                <div class="sidebar-nav-item">
                  12. <a class="sidebar-lesson " href="/vi/lessons/basics/testing/">Testing</a>
                </div>
              
                <div class="sidebar-nav-item">
                  13. <a class="sidebar-lesson " href="/vi/lessons/basics/comprehensions/">Comprehensions</a>
                </div>
              
                <div class="sidebar-nav-item">
                  14. <a class="sidebar-lesson " href="/vi/lessons/basics/strings/">Strings</a>
                </div>
              
                <div class="sidebar-nav-item">
                  15. <a class="sidebar-lesson " href="/vi/lessons/basics/mix-tasks/">Custom Mix Tasks</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group advanced">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Nâng cao</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/vi/lessons/advanced/erlang/">Erlang Interoperability</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/vi/lessons/advanced/error-handling/">Error Handling</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/vi/lessons/advanced/escripts/">Executables</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/vi/lessons/advanced/concurrency/">Xử lý đồng thời</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/vi/lessons/advanced/otp-concurrency/">OTP Concurrency</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/vi/lessons/advanced/otp-supervisors/">OTP Supervisors</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson " href="/vi/lessons/advanced/metaprogramming/">Metaprogramming</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/vi/lessons/advanced/umbrella-projects/">Umbrella Projects</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/vi/lessons/advanced/typespec/">Specifications and types</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/vi/lessons/advanced/behaviours/">Behaviours</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/vi/lessons/advanced/gen-stage/">GenStage</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group specifics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-down "></i>
              <span>Cụ thể</span>
            </div>
            <div class="sidebar-nav-list" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson  active" href="/vi/lessons/specifics/plug/">Plug</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/vi/lessons/specifics/ecto/">Ecto</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/vi/lessons/specifics/eex/">Embedded Elixir (EEx)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/vi/lessons/specifics/ets/">Erlang Term Storage (ETS)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/vi/lessons/specifics/mnesia/">Mnesia</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group libraries">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Thư viện</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/vi/lessons/libraries/guardian/">Guardian (Basics)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/vi/lessons/libraries/poolboy/">Poolboy</a>
                </div>
              
            </div>
          </div>
        
      
    </nav>

    <p>
      

      
        <a href=" /lessons/specifics/plug/ ">en</a>
      
        <a href=" /jp/lessons/specifics/plug/ ">jp</a>
      
        <a href=" /cn/lessons/specifics/plug/ ">cn</a>
      
        <a href=" /es/lessons/specifics/plug/ ">es</a>
      
        <a href=" /pt/lessons/specifics/plug/ ">pt</a>
      
        <a href=" /vi/lessons/specifics/plug/ ">vi</a>
      
        <a href=" /ru/lessons/specifics/plug/ ">ru</a>
      
        <a href=" /sk/lessons/specifics/plug/ ">sk</a>
      
        <a href=" /fr/lessons/specifics/plug/ ">fr</a>
      
        <a href=" /gr/lessons/specifics/plug/ ">gr</a>
      
        <a href=" /it/lessons/specifics/plug/ ">it</a>
      
        <a href=" /pl/lessons/specifics/plug/ ">pl</a>
      
        <a href=" /my/lessons/specifics/plug/ ">my</a>
      
        <a href=" /no/lessons/specifics/plug/ ">no</a>
      
        <a href=" /ko/lessons/specifics/plug/ ">ko</a>
      
        <a href=" /id/lessons/specifics/plug/ ">id</a>
      
        <a href=" /uk/lessons/specifics/plug/ ">uk</a>
      
        <a href=" /tr/lessons/specifics/plug/ ">tr</a>
      
        <a href=" /bg/lessons/specifics/plug/ ">bg</a>
      
        <a href=" /de/lessons/specifics/plug/ ">de</a>
      
        <a href=" /bn/lessons/specifics/plug/ ">bn</a>
      
    </p>

    <p>&copy; 2017 <a href="https://github.com/doomspork">Sean Callan</a></p>
  </div>
</div>


    <div class="content container">
      <div class="page">
  <h1 class="page-title">Plug</h1>
  <p>If you’re familiar with Ruby you can think of Plug as Rack with a splash of Sinatra.  It provides a specification for web application components and adapters for web servers. While not part of Elixir core, Plug is an official Elixir project.</p>

<h2>Mục lục</h2>
<div id="toc"></div>

<h2 id="installation">Installation</h2>

<p>Installation is a breeze with mix.  To install Plug we need to make two small changes to our <code class="highlighter-rouge">mix.exs</code>.  The first thing to do is add both Plug and a web server (we’ll be using Cowboy) to our file as dependencies:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0.0"</span><span class="p">},</span>
   <span class="p">{</span><span class="ss">:plug</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The last thing we need to do is add both our web server and Plug to our OTP application:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span><span class="ss">applications:</span> <span class="p">[</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:logger</span><span class="p">,</span> <span class="ss">:plug</span><span class="p">]]</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="the-specification">The specification</h2>

<p>In order to begin creating Plugs, we need to know, and adhere to, the Plug spec.  Thankfully for us, there are only two functions necessary: <code class="highlighter-rouge">init/1</code> and <code class="highlighter-rouge">call/2</code>.</p>

<p>The <code class="highlighter-rouge">init/1</code> function is used to initialize our Plug’s options, which are passed as the second argument to our <code class="highlighter-rouge">call/2</code> function.  In addition to our initialized options the <code class="highlighter-rouge">call/2</code> function receives a <code class="highlighter-rouge">%Plug.Conn</code> as its first argument and is expected to return a connection.</p>

<p>Here’s a simple Plug that returns “Hello World!”:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">HelloWorldPlug</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">options</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_resp_content_type</span><span class="p">(</span><span class="sd">"</span><span class="s2">text/plain"</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">send_resp</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Hello World!"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="creating-a-plug">Creating a Plug</h2>

<p>For this example we’ll create a Plug to verify whether or not the request has some set of required parameters.  By implementing our validation in a Plug we can be assured that only valid requests will make it through to our application.  We will expect our Plug to be initialized with two options: <code class="highlighter-rouge">:paths</code> and <code class="highlighter-rouge">:fields</code>.  These will represent the paths we apply our logic to and which fields to require.</p>

<p><em>Note</em>: Plugs are applied to all requests which is why we will handle filtering requests and applying our logic to only a subset of them.  To ignore a request we simply pass the connection through.</p>

<p>We’ll start by looking at our finished Plug and then discuss how it works.  We’ll create it at <code class="highlighter-rouge">lib/plug/verify_request.ex</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyRequest</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>

  <span class="k">defmodule</span> <span class="no">IncompleteRequestError</span> <span class="k">do</span>
    <span class="nv">@moduledoc</span> <span class="sd">"""
    Error raised when a required field is missing.
    """</span>

    <span class="k">defexception</span> <span class="ss">message:</span> <span class="sd">"</span><span class="s2">"</span><span class="p">,</span> <span class="ss">plug_status:</span> <span class="m">400</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">options</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="n">options</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(%</span><span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span><span class="p">{</span><span class="ss">request_path:</span> <span class="n">path</span><span class="p">}</span> <span class="o">=</span> <span class="n">conn</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">[</span><span class="ss">:paths</span><span class="p">],</span> <span class="k">do</span><span class="p">:</span> <span class="n">verify_request!</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">body_params</span><span class="p">,</span> <span class="n">opts</span><span class="p">[</span><span class="ss">:fields</span><span class="p">])</span>
    <span class="n">conn</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">verify_request!</span><span class="p">(</span><span class="n">body_params</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">verified</span> <span class="o">=</span> <span class="n">body_params</span>
               <span class="o">|&gt;</span> <span class="no">Map</span><span class="o">.</span><span class="n">keys</span>
               <span class="o">|&gt;</span> <span class="n">contains_fields?</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">verified</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="k">raise</span> <span class="no">IncompleteRequestError</span>
  <span class="k">end</span>

  <span class="k">defp</span> <span class="n">contains_fields?</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">fields</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="no">Enum</span><span class="o">.</span><span class="n">all?</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="nv">&amp;1</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">))</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The first thing to note is we have defined a new exception <code class="highlighter-rouge">IncompleteRequestError</code> and that one of its options is <code class="highlighter-rouge">:plug_status</code>.  When available this option is used by Plug to set the HTTP status code in the event of an exception.</p>

<p>The second portion of our Plug is the <code class="highlighter-rouge">call/2</code> method.  This is where we decide whether or not to apply our verification logic.  Only when the request’s path is contained in our <code class="highlighter-rouge">:paths</code> option will we call <code class="highlighter-rouge">verify_request!/2</code>.</p>

<p>The last portion of our plug is the private function <code class="highlighter-rouge">verify_request!/2</code> which verifies whether the required <code class="highlighter-rouge">:fields</code> are all present.  In the event that some are missing, we raise <code class="highlighter-rouge">IncompleteRequestError</code>.</p>

<h2 id="using-plugrouter">Using Plug.Router</h2>

<p>Now that we have our <code class="highlighter-rouge">VerifyRequest</code> plug, we can move on to our router.  As we are about to see, we don’t need a framework like Sinatra in Elixir since we get that for free with Plug.</p>

<p>To start let’s create a file at <code class="highlighter-rouge">lib/plug/router.ex</code> and copy the following into it:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="n">plug</span> <span class="ss">:match</span>
  <span class="n">plug</span> <span class="ss">:dispatch</span>

  <span class="n">get</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Welcome"</span><span class="p">)</span>
  <span class="n">match</span> <span class="n">_</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">404</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Oops!"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>This is a bare minimum Router but the code should be pretty self-explanatory.  We’ve included some macros through <code class="highlighter-rouge">use Plug.Router</code> and then set up two of the built-in Plugs: <code class="highlighter-rouge">:match</code> and <code class="highlighter-rouge">:dispatch</code>.   There are two defined routes, one for handling GET requests to the root and the second for matching all other requests so we can return a 404 message.</p>

<p>Let’s add our Plug to the router:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="n">alias</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyRequest</span>

  <span class="n">plug</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Parsers</span><span class="p">,</span> <span class="ss">parsers:</span> <span class="p">[</span><span class="ss">:urlencoded</span><span class="p">,</span> <span class="ss">:multipart</span><span class="p">]</span>
  <span class="n">plug</span> <span class="no">VerifyRequest</span><span class="p">,</span> <span class="ss">fields:</span> <span class="p">[</span><span class="sd">"</span><span class="s2">content"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">mimetype"</span><span class="p">],</span>
                      <span class="ss">paths:</span>  <span class="p">[</span><span class="sd">"</span><span class="s2">/upload"</span><span class="p">]</span>
  <span class="n">plug</span> <span class="ss">:match</span>
  <span class="n">plug</span> <span class="ss">:dispatch</span>

  <span class="n">get</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Welcome"</span><span class="p">)</span>
  <span class="n">post</span> <span class="sd">"</span><span class="s2">/upload"</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">201</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Uploaded"</span><span class="p">)</span>
  <span class="n">match</span> <span class="n">_</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">send_resp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="m">404</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Oops!"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>That’s it!  We’ve set up our Plug to verify that all requests to <code class="highlighter-rouge">/upload</code> include both <code class="highlighter-rouge">"content"</code> and <code class="highlighter-rouge">"mimetype"</code>.  Only then will the route code be executed.</p>

<p>For now our <code class="highlighter-rouge">/upload</code> endpoint isn’t very useful but we’ve seen how to create and integrate our Plug.</p>

<h2 id="running-our-web-app">Running our web app</h2>

<p>Before we can run our application we need to set up and configure our web server, which in this instance is Cowboy.  For now we’ll just make the code changes necessary to run everything, and we’ll dig into specifics in later lessons.</p>

<p>Let’s start by updating the <code class="highlighter-rouge">application</code> portion of our <code class="highlighter-rouge">mix.exs</code> to tell Elixir about our application and set an application env variable.  With those changes in place our code should look something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span><span class="ss">applications:</span> <span class="p">[</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:plug</span><span class="p">],</span>
   <span class="ss">mod:</span> <span class="p">{</span><span class="no">Example</span><span class="p">,</span> <span class="p">[]},</span>
   <span class="ss">env:</span> <span class="p">[</span><span class="ss">cowboy_port:</span> <span class="m">8080</span><span class="p">]]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Next we need to update <code class="highlighter-rouge">lib/example.ex</code> to start and supervise Cowboy:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Application</span>

  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">port</span> <span class="o">=</span> <span class="no">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="ss">:example</span><span class="p">,</span> <span class="ss">:cowboy_port</span><span class="p">,</span> <span class="m">8080</span><span class="p">)</span>

    <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
      <span class="no">Plug</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Cowboy</span><span class="o">.</span><span class="n">child_spec</span><span class="p">(</span><span class="ss">:http</span><span class="p">,</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span><span class="p">,</span> <span class="p">[],</span> <span class="ss">port:</span> <span class="n">port</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<blockquote>
  <p>(Optional) add <code class="highlighter-rouge">:cowboy_port</code> in <code class="highlighter-rouge">config/config.exs</code></p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">use</span> <span class="no">Mix</span><span class="o">.</span><span class="no">Config</span>

<span class="n">config</span> <span class="ss">:example</span><span class="p">,</span> <span class="ss">cowboy_port:</span> <span class="m">8080</span>
</code></pre>
</div>

<p>Now to run our application we can use:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mix run --no-halt
</code></pre>
</div>

<h2 id="testing-a-plug">Testing a Plug</h2>

<p>Testing Plugs is pretty straightforward thanks to <code class="highlighter-rouge">Plug.Test</code>.  It includes a number of convenience functions to make testing easy.</p>

<p>See if you can follow along with the router test:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">RouterTest</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">ExUnit</span><span class="o">.</span><span class="no">Case</span>
  <span class="kn">use</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Test</span>

  <span class="n">alias</span> <span class="no">Example</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">Router</span>

  <span class="nv">@content</span> <span class="sd">"</span><span class="s2">&lt;html&gt;&lt;body&gt;Hi!&lt;/body&gt;&lt;/html&gt;"</span>
  <span class="nv">@mimetype</span> <span class="sd">"</span><span class="s2">text/html"</span>

  <span class="nv">@opts</span> <span class="no">Router</span><span class="o">.</span><span class="n">init</span><span class="p">([])</span>

  <span class="n">test</span> <span class="sd">"</span><span class="s2">returns welcome"</span> <span class="k">do</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">"</span><span class="p">)</span>
           <span class="o">|&gt;</span> <span class="no">Router</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nv">@opts</span><span class="p">)</span>

    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="ss">:sent</span>
    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="m">200</span>
  <span class="k">end</span>

  <span class="n">test</span> <span class="sd">"</span><span class="s2">returns uploaded"</span> <span class="k">do</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">(</span><span class="ss">:post</span><span class="p">,</span> <span class="sd">"</span><span class="s2">/upload"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">content=</span><span class="si">#{</span><span class="nv">@content</span><span class="si">}</span><span class="s2">&amp;mimetype=</span><span class="si">#{</span><span class="nv">@mimetype</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
           <span class="o">|&gt;</span> <span class="n">put_req_header</span><span class="p">(</span><span class="sd">"</span><span class="s2">content-type"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">application/x-www-form-urlencoded"</span><span class="p">)</span>
           <span class="o">|&gt;</span> <span class="no">Router</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nv">@opts</span><span class="p">)</span>

    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="ss">:sent</span>
    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="m">201</span>
  <span class="k">end</span>

  <span class="n">test</span> <span class="sd">"</span><span class="s2">returns 404"</span> <span class="k">do</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="sd">"</span><span class="s2">/missing"</span><span class="p">,</span> <span class="sd">"</span><span class="s2">"</span><span class="p">)</span>
           <span class="o">|&gt;</span> <span class="no">Router</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nv">@opts</span><span class="p">)</span>

    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="ss">:sent</span>
    <span class="n">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="m">404</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="available-plugs">Available Plugs</h2>

<p>There are a number of Plugs available out-of-the-box.  The complete list can be found in the Plug docs <a href="https://github.com/elixir-lang/plug#available-plugs">here</a>.</p>


  

<hr />
<h3 id="social">
  
    Chia sẻ trang này
  
</h3>
<div class="social__container">
  <div class="social__item">
    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://elixirschool.com/vi/lessons/specifics/plug/&title=Plug&summary=description&source=https://elixirschool.com" class="social__icon--linkedin"><i class="icon--linkedin"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://twitter.com/intent/tweet?url=https://elixirschool.com/vi/lessons/specifics/plug/&via=elixirschool&text=ElixirSchool: Plug&hashtags=learnelixir%2Celixirlang&" class="social__icon--twitter"><i class="icon--twitter"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://plus.google.com/share?url=https://elixirschool.com/vi/lessons/specifics/plug/" class="social__icon--googleplus"><i class="icon--googleplus"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://elixirschool.com/vi/lessons/specifics/plug/" class="social__icon--facebook"><i class="icon--facebook"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.pinterest.com/pin/create/link/?url=https://elixirschool.com/vi/lessons/specifics/plug/&media=https://elixirschool.com/assets/fb_share.jpg&description=ElixirSchool: Plug" class="social__icon--pinterest"><i class="icon--pinterest"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.evernote.com/noteit.action?url=https://elixirschool.com/vi/lessons/specifics/plug/&title=ElixirSchool: Plug&suggestTags=elixir,programming" class="social__icon--evernote"><i class="icon--evernote"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://vk.com/share.php?url=https://elixirschool.com/vi/lessons/specifics/plug/&title=ElixirSchool: Plug&description=Check out 'Plug' on ElixirSchool" class="social__icon--vk" style="margin-left: 2px;"><i class="icon--vk"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="mailto:?&subject=ElixirSchool: Plug&body=Check out 'Plug' on ElixirSchool%0D%0A%0D%0Ahttps://elixirschool.com/vi/lessons/specifics/plug/" class="social__icon--email"><i class="icon--email"></i></a>
  </div>
  <div class="social__item">
    <a href="javascript:window.print()" class="social__icon--print"><i class="icon--print"></i></a>
  </div>
</div>
</div>
    </div>
  <script type="text/javascript" src="/assets/app.js"></script>
  </body>
</html>
