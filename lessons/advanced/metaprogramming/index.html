<!DOCTYPE html>

<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link href="http://gmpg.org/xfn/11" rel="profile">

  <meta name="description" content="Lessons about the Elixir programming language">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="https://elixirschool.com/lessons/advanced/metaprogramming/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="
  Metaprogramming &middot; Elixir School

">
  <meta property="og:description" content="Lessons about the Elixir programming language">
  <meta property="og:image" content="https://elixirschool.com/assets/fb_share.jpg">

  <title>
    
  Metaprogramming &middot; Elixir School


  </title>

  <!-- CSS -->
  <link type="text/css" rel="stylesheet" href="/assets/app.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>

</head>


  
  <body class="theme-custom-purple ">
    <a id="github_ribbon" href="https://github.com/doomspork/elixir_school"><img src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Elixir School
        </a>
      </h1>
      <p class="lead">Lessons about the Elixir programming language</p>
    </div>

    <nav class="sidebar-nav">
      
      
        
        
        
        
          <div class="sidebar-nav-group basics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Basics</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/basics/basics/">Basics</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/basics/collections/">Collections</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/basics/enum/">Enum</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/basics/pattern-matching/">Pattern Matching</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/basics/control-structures/">Control Structures</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/lessons/basics/functions/">Functions</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson " href="/lessons/basics/pipe-operator/">Pipe Operator</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/lessons/basics/modules/">Modules</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/lessons/basics/mix/">Mix</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/lessons/basics/sigils/">Sigils</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/lessons/basics/documentation/">Documentation</a>
                </div>
              
                <div class="sidebar-nav-item">
                  12. <a class="sidebar-lesson " href="/lessons/basics/testing/">Testing</a>
                </div>
              
                <div class="sidebar-nav-item">
                  13. <a class="sidebar-lesson " href="/lessons/basics/comprehensions/">Comprehensions</a>
                </div>
              
                <div class="sidebar-nav-item">
                  14. <a class="sidebar-lesson " href="/lessons/basics/strings/">Strings</a>
                </div>
              
                <div class="sidebar-nav-item">
                  15. <a class="sidebar-lesson " href="/lessons/basics/mix-tasks/">Custom Mix Tasks</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group advanced">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-down "></i>
              <span>Advanced</span>
            </div>
            <div class="sidebar-nav-list" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/advanced/erlang/">Erlang Interoperability</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/advanced/error-handling/">Error Handling</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/advanced/escripts/">Executables</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/advanced/concurrency/">Concurrency</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/advanced/otp-concurrency/">OTP Concurrency</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/lessons/advanced/otp-supervisors/">OTP Supervisors</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson  active" href="/lessons/advanced/metaprogramming/">Metaprogramming</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/lessons/advanced/umbrella-projects/">Umbrella Projects</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/lessons/advanced/typespec/">Specifications and types</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/lessons/advanced/behaviours/">Behaviours</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/lessons/advanced/gen-stage/">GenStage</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group specifics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Specifics</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/specifics/plug/">Plug</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/specifics/ecto/">Ecto</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/specifics/eex/">Embedded Elixir (EEx)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/specifics/ets/">Erlang Term Storage (ETS)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/specifics/mnesia/">Mnesia</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group libraries">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Libraries</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/libraries/guardian/">Guardian (Basics)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/libraries/poolboy/">Poolboy</a>
                </div>
              
            </div>
          </div>
        
      
    </nav>

    <p>
      

      
        <a href=" /lessons/advanced/metaprogramming/ ">en</a>
      
        <a href=" /jp/lessons/advanced/metaprogramming/ ">jp</a>
      
        <a href=" /cn/lessons/advanced/metaprogramming/ ">cn</a>
      
        <a href=" /es/lessons/advanced/metaprogramming/ ">es</a>
      
        <a href=" /pt/lessons/advanced/metaprogramming/ ">pt</a>
      
        <a href=" /vi/lessons/advanced/metaprogramming/ ">vi</a>
      
        <a href=" /ru/lessons/advanced/metaprogramming/ ">ru</a>
      
        <a href=" /sk/lessons/advanced/metaprogramming/ ">sk</a>
      
        <a href=" /fr/lessons/advanced/metaprogramming/ ">fr</a>
      
        <a href=" /gr/lessons/advanced/metaprogramming/ ">gr</a>
      
        <a href=" /it/lessons/advanced/metaprogramming/ ">it</a>
      
        <a href=" /pl/lessons/advanced/metaprogramming/ ">pl</a>
      
        <a href=" /my/lessons/advanced/metaprogramming/ ">my</a>
      
        <a href=" /no/lessons/advanced/metaprogramming/ ">no</a>
      
        <a href=" /ko/lessons/advanced/metaprogramming/ ">ko</a>
      
        <a href=" /id/lessons/advanced/metaprogramming/ ">id</a>
      
        <a href=" /uk/lessons/advanced/metaprogramming/ ">uk</a>
      
        <a href=" /tr/lessons/advanced/metaprogramming/ ">tr</a>
      
        <a href=" /bg/lessons/advanced/metaprogramming/ ">bg</a>
      
        <a href=" /de/lessons/advanced/metaprogramming/ ">de</a>
      
        <a href=" /bn/lessons/advanced/metaprogramming/ ">bn</a>
      
    </p>

    <p>&copy; 2017 <a href="https://github.com/doomspork">Sean Callan</a></p>
  </div>
</div>


    <div class="content container">
      <div class="page">
  <h1 class="page-title">Metaprogramming</h1>
  <p>Metaprogramming is the process of using code to write code.  In Elixir this gives us the ability to extend the language to fit our needs and dynamically change the code.  We’ll start by looking at how Elixir is represented under the hood, then how to modify it, and finally we can use this knowledge to extend it.</p>

<p>A word of caution:  Metaprogramming is tricky and should only be used when necessary. Overuse will almost certainly lead to complex code that is difficult to understand and debug.</p>

<h2>Table of Contents</h2>
<div id="toc"></div>

<h2 id="quote">Quote</h2>

<p>The first step to metaprogramming is understanding how expressions are represented.  In Elixir the abstract syntax tree (AST), the internal representation of our code, is composed of tuples.  These tuples contain three parts: function name, metadata, and function arguments.</p>

<p>In order to see these internal structures, Elixir supplies us with the <code class="highlighter-rouge">quote/2</code> function.  Using <code class="highlighter-rouge">quote/2</code> we can convert Elixir code into its underlying representation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="m">42</span>
<span class="m">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">Hello"</span>
<span class="sd">"</span><span class="s2">Hello"</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="ss">:world</span>
<span class="ss">:world</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="m">1</span> <span class="o">+</span> <span class="m">2</span>
<span class="p">{</span><span class="ss">:+</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">]}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="k">if</span> <span class="n">value</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">True"</span><span class="p">,</span> <span class="k">else</span><span class="p">:</span> <span class="sd">"</span><span class="s2">False"</span>
<span class="p">{</span><span class="ss">:if</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
 <span class="p">[{</span><span class="ss">:value</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">True"</span><span class="p">,</span> <span class="k">else</span><span class="p">:</span> <span class="sd">"</span><span class="s2">False"</span><span class="p">]]}</span>
</code></pre>
</div>

<p>Notice the first three don’t return tuples?  There are five literals that return themselves when quoted:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="ss">:atom</span>
<span class="ss">:atom</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="sd">"</span><span class="s2">string"</span>
<span class="sd">"</span><span class="s2">string"</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="m">1</span> <span class="c1"># All numbers</span>
<span class="m">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span> <span class="c1"># Lists</span>
<span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="p">{</span><span class="sd">"</span><span class="s2">hello"</span><span class="p">,</span> <span class="ss">:world</span><span class="p">}</span> <span class="c1"># 2 element tuples</span>
<span class="p">{</span><span class="sd">"</span><span class="s2">hello"</span><span class="p">,</span> <span class="ss">:world</span><span class="p">}</span>
</code></pre>
</div>

<h2 id="unquote">Unquote</h2>

<p>Now that we can retrieve the internal structure of our code, how do we modify it?  To inject new code or values we use <code class="highlighter-rouge">unquote/1</code>.  When we unquote an expression it will be evaluated and injected into the AST.  To demonstrate <code class="highlighter-rouge">unquote/1</code> let’s look at some examples:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">denominator</span> <span class="o">=</span> <span class="m">2</span>
<span class="m">2</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">divide</span><span class="p">(</span><span class="m">42</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span>
<span class="p">{</span><span class="ss">:divide</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="m">42</span><span class="p">,</span> <span class="p">{</span><span class="ss">:denominator</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">divide</span><span class="p">(</span><span class="m">42</span><span class="p">,</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">denominator</span><span class="p">))</span>
<span class="p">{</span><span class="ss">:divide</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="m">42</span><span class="p">,</span> <span class="m">2</span><span class="p">]}</span>
</code></pre>
</div>

<p>In the first example our variable <code class="highlighter-rouge">denominator</code> is quoted so the resulting AST includes a tuple for accessing the variable.  In the <code class="highlighter-rouge">unquote/1</code> example the resulting code includes the value of <code class="highlighter-rouge">denominator</code> instead.</p>

<h2 id="macros">Macros</h2>

<p>Once we understand <code class="highlighter-rouge">quote/2</code> and <code class="highlighter-rouge">unquote/1</code> we’re ready to dive into macros.  It is important to remember that macros, like all metaprogramming, should be used sparingly.</p>

<p>In the simplest of terms macros are special functions designed to return a quoted expression that will be inserted into our application code.  Imagine the macro being replaced with the quoted expression rather than called like a function.  With macros we have everything necessary to extend Elixir and dynamically add code to our applications.</p>

<p>We begin by defining a macro using <code class="highlighter-rouge">defmacro/2</code> which, like much of Elixir, is itself a macro (let that sink in).  As an example we’ll implement <code class="highlighter-rouge">unless</code> as a macro.  Remember that our macro needs to return a quoted expression:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">OurMacro</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">unless</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">block</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">!unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Let’s require our module and give our macro a whirl:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">OurMacro</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span> <span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">Hi"</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span> <span class="no">false</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">Hi"</span>
<span class="sd">"</span><span class="s2">Hi"</span>
</code></pre>
</div>

<p>Because macros replace code in our application, we can control when and what is compiled.  An example of this can be found in the <code class="highlighter-rouge">Logger</code> module.  When logging is disabled no code is injected and the resulting application contains no references or function calls to logging.  This is different from other languages where there is still the overhead of a function call even when the implementation is NOP.</p>

<p>To demonstrate this we’ll make a simple logger that can either be enabled or disabled:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Logger</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="ss">:logger</span><span class="p">,</span> <span class="ss">:enabled</span><span class="p">)</span> <span class="k">do</span>
      <span class="kn">quote</span> <span class="k">do</span>
        <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Logged message: </span><span class="si">#{</span><span class="kn">unquote</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="kn">require</span> <span class="no">Logger</span>

  <span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
    <span class="no">Logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sd">"</span><span class="s2">This is a log message"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>With logging enabled our <code class="highlighter-rouge">test</code> function would result in code looking something like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
  <span class="no">IO</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="sd">"</span><span class="s2">Logged message: </span><span class="si">#{</span><span class="sd">"</span><span class="s2">This is a log message"</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>If we disable logging the resulting code would be:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">test</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre>
</div>

<h2 id="debugging">Debugging</h2>

<p>Okay, right now we know how to use <code class="highlighter-rouge">quote/2</code>, <code class="highlighter-rouge">unquote/1</code> and write macros. But what if you have a huge chunk of quoted code and want to understand it? In this case, you can use <code class="highlighter-rouge">Macro.to_string/2</code>. Take a look at this example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="kn">quote</span><span class="p">(</span><span class="k">do</span><span class="p">:</span> <span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)))</span>
<span class="sd">"</span><span class="s2">foo.bar(1, 2, 3)"</span>
</code></pre>
</div>

<p>And when you want to look at the code generated by macros you can combine them with <code class="highlighter-rouge">Macro.expand/2</code> and <code class="highlighter-rouge">Macro.expand_once/2</code>, these functions expand macros into their given quoted code. The first may expand it several times, while the former - only once. For example, let’s modify <code class="highlighter-rouge">unless</code> example from the previous section:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">OurMacro</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="k">unless</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">block</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">!unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kn">require</span> <span class="no">OurMacro</span>
<span class="n">quoted</span> <span class="o">=</span> <span class="kn">quote</span> <span class="k">do</span>
  <span class="no">OurMacro</span><span class="o">.</span><span class="k">unless</span> <span class="no">true</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="sd">"</span><span class="s2">Hi"</span>
<span class="k">end</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>iex&gt; quoted |&gt; Macro.expand_once(__ENV__) |&gt; Macro.to_string |&gt; IO.puts
if(!true) do
  "Hi"
end
</code></pre>
</div>

<p>If we run the same code with <code class="highlighter-rouge">Macro.expand/2</code>, it’s intriguing:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">quoted</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">__ENV__</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">to_string</span> <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span>
<span class="k">case</span><span class="p">(</span><span class="n">!true</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">x</span> <span class="ow">when</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="no">false</span><span class="p">,</span> <span class="no">nil</span><span class="p">]</span> <span class="o">-&gt;</span>
    <span class="no">nil</span>
  <span class="n">_</span> <span class="o">-&gt;</span>
    <span class="sd">"</span><span class="s2">Hi"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>You may recall that we’ve mentioned <code class="highlighter-rouge">if</code> is a macro in Elixir, here we see it expanded into the underlying <code class="highlighter-rouge">case</code> statement.</p>

<h3 id="private-macros">Private Macros</h3>

<p>Though not as common, Elixir does support private macros.  A private macro is defined with <code class="highlighter-rouge">defmacrop</code> and can only be called from the module in which it was defined.  Private macros must be defined before the code that invokes them.</p>

<h3 id="macro-hygiene">Macro Hygiene</h3>

<p>How macros interact with the caller’s context when expanded is known as macro hygiene. By default macros in Elixir are hygienic and will not conflict with our context:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">hygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="m">42</span>
<span class="m">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">hygienic</span>
<span class="o">-</span><span class="m">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="m">42</span>
</code></pre>
</div>

<p>What if we wanted to manipulate the value of <code class="highlighter-rouge">val</code>?  To mark a variable as being unhygienic we can use <code class="highlighter-rouge">var!/2</code>.  Let’s update our example to include another macro utilizing <code class="highlighter-rouge">var!/2</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">hygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>
  <span class="k">end</span>

  <span class="k">defmacro</span> <span class="n">unhygienic</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span><span class="p">:</span> <span class="n">var!</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="m">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Let’s compare how they interact with our context:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span> <span class="o">=</span> <span class="m">42</span>
<span class="m">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">hygienic</span>
<span class="o">-</span><span class="m">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="m">42</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">unhygienic</span>
<span class="o">-</span><span class="m">1</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="n">val</span>
<span class="o">-</span><span class="m">1</span>
</code></pre>
</div>

<p>By including <code class="highlighter-rouge">var!/2</code> in our macro we manipulated the value of <code class="highlighter-rouge">val</code> without passing it into our macro.  The use of non-hygienic macros should be kept to a minimum.  By including <code class="highlighter-rouge">var!/2</code> we increase the risk of a variable resolution conflict.</p>

<h3 id="binding">Binding</h3>

<p>We already covered the usefulness of <code class="highlighter-rouge">unquote/1</code>, but there’s another way to inject values into our code: binding.  With variable binding we are able to include multiple variables in our macro and ensure they’re only unquoted once, avoiding accidental revaluations. To use bound variables we need to pass a keyword list to the <code class="highlighter-rouge">bind_quoted</code> option in <code class="highlighter-rouge">quote/2</code>.</p>

<p>To see the benefit of <code class="highlighter-rouge">bind_quote</code> and to demonstrate the revaluation issue let’s use an example.  We can start by creating a macro that simply outputs the expression twice:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">double_puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>We’ll try out our new macro by passing it the current system time.  We should expect to see it output twice:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">double_puts</span><span class="p">(</span><span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">)</span>
<span class="m">1450475941851668000</span>
<span class="m">1450475941851733000</span>
</code></pre>
</div>

<p>The times are different!  What happened?  Using <code class="highlighter-rouge">unquote/1</code> on the same expression multiple times results in revaluation and that can have unintended consequences.  Let’s update the example to use <code class="highlighter-rouge">bind_quoted</code> and see what we get:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Example</span> <span class="k">do</span>
  <span class="k">defmacro</span> <span class="n">double_puts</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span> <span class="k">do</span>
    <span class="kn">quote</span> <span class="ss">bind_quoted:</span> <span class="p">[</span><span class="ss">expr:</span> <span class="n">expr</span><span class="p">]</span> <span class="k">do</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="n">expr</span>
      <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="n">expr</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">iex</span><span class="o">&gt;</span> <span class="kn">require</span> <span class="no">Example</span>
<span class="no">nil</span>
<span class="n">iex</span><span class="o">&gt;</span> <span class="no">Example</span><span class="o">.</span><span class="n">double_puts</span><span class="p">(</span><span class="ss">:os</span><span class="o">.</span><span class="n">system_time</span><span class="p">)</span>
<span class="m">1450476083466500000</span>
<span class="m">1450476083466500000</span>
</code></pre>
</div>

<p>With <code class="highlighter-rouge">bind_quoted</code> we get our expected outcome: the same time printed twice.</p>

<p>Now that we’ve covered <code class="highlighter-rouge">quote/2</code>, <code class="highlighter-rouge">unquote/1</code>, and <code class="highlighter-rouge">defmacro/2</code> we have all the tools necessary to extend Elixir to suit our needs.</p>


  

<hr />
<h3 id="social">
  
    Share This Page
  
</h3>
<div class="social__container">
  <div class="social__item">
    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://elixirschool.com/lessons/advanced/metaprogramming/&title=Metaprogramming&summary=description&source=https://elixirschool.com" class="social__icon--linkedin"><i class="icon--linkedin"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://twitter.com/intent/tweet?url=https://elixirschool.com/lessons/advanced/metaprogramming/&via=elixirschool&text=ElixirSchool: Metaprogramming&hashtags=learnelixir%2Celixirlang&" class="social__icon--twitter"><i class="icon--twitter"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://plus.google.com/share?url=https://elixirschool.com/lessons/advanced/metaprogramming/" class="social__icon--googleplus"><i class="icon--googleplus"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://elixirschool.com/lessons/advanced/metaprogramming/" class="social__icon--facebook"><i class="icon--facebook"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.pinterest.com/pin/create/link/?url=https://elixirschool.com/lessons/advanced/metaprogramming/&media=https://elixirschool.com/assets/fb_share.jpg&description=ElixirSchool: Metaprogramming" class="social__icon--pinterest"><i class="icon--pinterest"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.evernote.com/noteit.action?url=https://elixirschool.com/lessons/advanced/metaprogramming/&title=ElixirSchool: Metaprogramming&suggestTags=elixir,programming" class="social__icon--evernote"><i class="icon--evernote"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://vk.com/share.php?url=https://elixirschool.com/lessons/advanced/metaprogramming/&title=ElixirSchool: Metaprogramming&description=Check out 'Metaprogramming' on ElixirSchool" class="social__icon--vk" style="margin-left: 2px;"><i class="icon--vk"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="mailto:?&subject=ElixirSchool: Metaprogramming&body=Check out 'Metaprogramming' on ElixirSchool%0D%0A%0D%0Ahttps://elixirschool.com/lessons/advanced/metaprogramming/" class="social__icon--email"><i class="icon--email"></i></a>
  </div>
  <div class="social__item">
    <a href="javascript:window.print()" class="social__icon--print"><i class="icon--print"></i></a>
  </div>
</div>
</div>
    </div>
  <script type="text/javascript" src="/assets/app.js"></script>
  </body>
</html>
