<!DOCTYPE html>

<html lang="en-us">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <link href="http://gmpg.org/xfn/11" rel="profile">

  <meta name="description" content="Lessons about the Elixir programming language">
  <meta name="author" content="Sean Callan">

  <meta property="og:url" content="https://elixirschool.com/lessons/libraries/guardian/">
  <meta property="og:site_name" content="ElixirSchool">
  <meta property="og:title" content="
  Guardian (Basics) &middot; Elixir School

">
  <meta property="og:description" content="Lessons about the Elixir programming language">
  <meta property="og:image" content="https://elixirschool.com/assets/fb_share.jpg">

  <title>
    
  Guardian (Basics) &middot; Elixir School


  </title>

  <!-- CSS -->
  <link type="text/css" rel="stylesheet" href="/assets/app.css">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <script type="text/javascript">
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
  analytics.load("C0p07Sw9j7mZnycKDCgPOAyqJR5hhyoQ");
  analytics.page()
  }}();
  </script>

</head>


  
  <body class="theme-custom-purple ">
    <a id="github_ribbon" href="https://github.com/doomspork/elixir_school"><img src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

    
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Elixir School
        </a>
      </h1>
      <p class="lead">Lessons about the Elixir programming language</p>
    </div>

    <nav class="sidebar-nav">
      
      
        
        
        
        
          <div class="sidebar-nav-group basics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Basics</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/basics/basics/">Basics</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/basics/collections/">Collections</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/basics/enum/">Enum</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/basics/pattern-matching/">Pattern Matching</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/basics/control-structures/">Control Structures</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/lessons/basics/functions/">Functions</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson " href="/lessons/basics/pipe-operator/">Pipe Operator</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/lessons/basics/modules/">Modules</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/lessons/basics/mix/">Mix</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/lessons/basics/sigils/">Sigils</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/lessons/basics/documentation/">Documentation</a>
                </div>
              
                <div class="sidebar-nav-item">
                  12. <a class="sidebar-lesson " href="/lessons/basics/testing/">Testing</a>
                </div>
              
                <div class="sidebar-nav-item">
                  13. <a class="sidebar-lesson " href="/lessons/basics/comprehensions/">Comprehensions</a>
                </div>
              
                <div class="sidebar-nav-item">
                  14. <a class="sidebar-lesson " href="/lessons/basics/strings/">Strings</a>
                </div>
              
                <div class="sidebar-nav-item">
                  15. <a class="sidebar-lesson " href="/lessons/basics/mix-tasks/">Custom Mix Tasks</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group advanced">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Advanced</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/advanced/erlang/">Erlang Interoperability</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/advanced/error-handling/">Error Handling</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/advanced/escripts/">Executables</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/advanced/concurrency/">Concurrency</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/advanced/otp-concurrency/">OTP Concurrency</a>
                </div>
              
                <div class="sidebar-nav-item">
                  6. <a class="sidebar-lesson " href="/lessons/advanced/otp-supervisors/">OTP Supervisors</a>
                </div>
              
                <div class="sidebar-nav-item">
                  7. <a class="sidebar-lesson " href="/lessons/advanced/metaprogramming/">Metaprogramming</a>
                </div>
              
                <div class="sidebar-nav-item">
                  8. <a class="sidebar-lesson " href="/lessons/advanced/umbrella-projects/">Umbrella Projects</a>
                </div>
              
                <div class="sidebar-nav-item">
                  9. <a class="sidebar-lesson " href="/lessons/advanced/typespec/">Specifications and types</a>
                </div>
              
                <div class="sidebar-nav-item">
                  10. <a class="sidebar-lesson " href="/lessons/advanced/behaviours/">Behaviours</a>
                </div>
              
                <div class="sidebar-nav-item">
                  11. <a class="sidebar-lesson " href="/lessons/advanced/gen-stage/">GenStage</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group specifics">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-right "></i>
              <span>Specifics</span>
            </div>
            <div class="sidebar-nav-list"  style="display: none;" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson " href="/lessons/specifics/plug/">Plug</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/specifics/ecto/">Ecto</a>
                </div>
              
                <div class="sidebar-nav-item">
                  3. <a class="sidebar-lesson " href="/lessons/specifics/eex/">Embedded Elixir (EEx)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  4. <a class="sidebar-lesson " href="/lessons/specifics/ets/">Erlang Term Storage (ETS)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  5. <a class="sidebar-lesson " href="/lessons/specifics/mnesia/">Mnesia</a>
                </div>
              
            </div>
          </div>
        
      
        
        
        
        
          <div class="sidebar-nav-group libraries">
            <div class="sidebar-nav-header">
              <i class="fa  fa-chevron-down "></i>
              <span>Libraries</span>
            </div>
            <div class="sidebar-nav-list" >
              
                <div class="sidebar-nav-item">
                  1. <a class="sidebar-lesson  active" href="/lessons/libraries/guardian/">Guardian (Basics)</a>
                </div>
              
                <div class="sidebar-nav-item">
                  2. <a class="sidebar-lesson " href="/lessons/libraries/poolboy/">Poolboy</a>
                </div>
              
            </div>
          </div>
        
      
    </nav>

    <p>
      

      
        <a href=" /lessons/libraries/guardian/ ">en</a>
      
        <a href=" /jp/lessons/libraries/guardian/ ">jp</a>
      
        <a href=" /cn/lessons/libraries/guardian/ ">cn</a>
      
        <a href=" /es/lessons/libraries/guardian/ ">es</a>
      
        <a href=" /pt/lessons/libraries/guardian/ ">pt</a>
      
        <a href=" /vi/lessons/libraries/guardian/ ">vi</a>
      
        <a href=" /ru/lessons/libraries/guardian/ ">ru</a>
      
        <a href=" /sk/lessons/libraries/guardian/ ">sk</a>
      
        <a href=" /fr/lessons/libraries/guardian/ ">fr</a>
      
        <a href=" /gr/lessons/libraries/guardian/ ">gr</a>
      
        <a href=" /it/lessons/libraries/guardian/ ">it</a>
      
        <a href=" /pl/lessons/libraries/guardian/ ">pl</a>
      
        <a href=" /my/lessons/libraries/guardian/ ">my</a>
      
        <a href=" /no/lessons/libraries/guardian/ ">no</a>
      
        <a href=" /ko/lessons/libraries/guardian/ ">ko</a>
      
        <a href=" /id/lessons/libraries/guardian/ ">id</a>
      
        <a href=" /uk/lessons/libraries/guardian/ ">uk</a>
      
        <a href=" /tr/lessons/libraries/guardian/ ">tr</a>
      
        <a href=" /bg/lessons/libraries/guardian/ ">bg</a>
      
        <a href=" /de/lessons/libraries/guardian/ ">de</a>
      
        <a href=" /bn/lessons/libraries/guardian/ ">bn</a>
      
    </p>

    <p>&copy; 2017 <a href="https://github.com/doomspork">Sean Callan</a></p>
  </div>
</div>


    <div class="content container">
      <div class="page">
  <h1 class="page-title">Guardian (Basics)</h1>
  <p><a href="https://github.com/ueberauth/guardian">Guardian</a> is a widely used authentication library based on <a href="https://jwt.io/">JWT</a> (Javascript Web Token).</p>

<h2>Table of Contents</h2>
<div id="toc"></div>

<h2 id="jwts">JWTs</h2>

<p>A JWT can provide a rich token for authentication. Where many authentication systems provide access to only a subject identifier for the resource, JWTs provide this along with other information like:</p>

<ul>
  <li>Who issued the token</li>
  <li>Who is the token for</li>
  <li>Which system should use the token</li>
  <li>What time was it issued</li>
  <li>What time does the token expire</li>
</ul>

<p>In addition to these fields Guardian provides some other fields to facilitate additional functionality:</p>

<ul>
  <li>What type is the token</li>
  <li>What permissions does the bearer have</li>
</ul>

<p>These are just the basic fields in a JWT. You’re free to add any additional information that your application requires. Just remember to keep it short, as JWT has to fit in the HTTP header.</p>

<p>This richness means that you can pass JWTs around in your system as a fully contained unit of credentials.</p>

<h3 id="where-to-use-them">Where to use them</h3>

<p>JWT tokens can be used to authenticate any part of your application.</p>

<ul>
  <li>Single page applications</li>
  <li>Controllers (via browser session)</li>
  <li>Controllers (via authorization headers - API)</li>
  <li>Phoenix Channels</li>
  <li>Service to Service requests</li>
  <li>Inter-process</li>
  <li>3rd Party access (OAuth)</li>
  <li>Remember me functionality</li>
  <li>Other interfaces - raw TCP, UDP, CLI, etc</li>
</ul>

<p>JWT tokens can be used everywhere in your application where you need to provide verifiable authentication.</p>

<h3 id="do-i-have-to-use-a-database">Do I have to use a database?</h3>

<p>You do not need to track JWT via a database. You can simply rely on the issued and expiry timestamps for controlling access. Often you’ll end up using a database to look up your user resource but the JWT itself does not require it.</p>

<p>For example, if you were going to use JWT to authenticate communication on a UDP socket you likely wouldn’t use a database. Encode all the information you need directly into the token when you issue it. Once you verify it (check that it’s signed correctly) you’re good to go.</p>

<p>You <em>can</em> however use a database to track JWT. If you do, you gain the ability to verify that the token is still valid - that is - it has not been revoked. Or you could use the records in the DB to force a log out of all tokens for user 5. This is made simple in Guardian by using <a href="https://github.com/hassox/guardian_db">GuardianDb</a>. GuardianDb uses Guardians ‘Hooks’ to perform validation checks, save and delete from the DB. We’ll cover that later.</p>

<h2 id="setup">Setup</h2>

<p>There are many options for setting up Guardian. We’ll cover them at some point but let’s start with a very simple setup.</p>

<h3 id="minimal-setup">Minimal Setup</h3>

<p>To get started there are a handful of things that you’ll need.</p>

<h4 id="configuration">Configuration</h4>

<p><code class="highlighter-rouge">mix.exs</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="ss">mod:</span> <span class="p">{</span><span class="no">MyApp</span><span class="p">,</span> <span class="p">[]},</span>
    <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:guardian</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">guardian:</span> <span class="sd">"</span><span class="s2">~&gt; x.x"</span><span class="p">},</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">config/config.ex</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">config</span> <span class="ss">:guardian</span><span class="p">,</span> <span class="no">Guardian</span><span class="p">,</span>
  <span class="ss">issuer:</span> <span class="sd">"</span><span class="s2">MyAppId"</span><span class="p">,</span>
  <span class="ss">secret_key:</span> <span class="no">Mix</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="c1"># in each environment config file you should overwrite this if it's external</span>
  <span class="ss">serializer:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">GuardianSerializer</span>
</code></pre>
</div>

<p>This is the minimum set of information you need to provide Guardian with to operate. You shouldn’t encode your secret key directly into your top-level config. Instead, each environment should have its own key. It’s common to use the Mix environment for secrets in dev and test. Staging and production, however, must use strong secrets. (e.g. generated with <code class="highlighter-rouge">mix phoenix.gen.secret</code>)</p>

<p><code class="highlighter-rouge">lib/my_app/guardian_serializer.ex</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">GuardianSerializer</span> <span class="k">do</span>
  <span class="nv">@behaviour</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Serializer</span>

  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Repo</span>
  <span class="n">alias</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">User</span>

  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="p">%</span><span class="no">User</span><span class="p">{}),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="sd">"</span><span class="s2">User:</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">def</span> <span class="n">for_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>

  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="sd">"</span><span class="s2">User:"</span> <span class="o">&lt;&gt;</span> <span class="n">id</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:ok</span><span class="p">,</span> <span class="no">Repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">def</span> <span class="n">from_token</span><span class="p">(</span><span class="n">_</span><span class="p">),</span> <span class="k">do</span><span class="p">:</span> <span class="p">{</span> <span class="ss">:error</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Unknown resource type"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Your serializer is responsible for finding the resource identified in the <code class="highlighter-rouge">sub</code> (subject) field. This could be a lookup from a db, an API, or even a simple string.<br />
It’s also responsible for serializing a resource into the <code class="highlighter-rouge">sub</code> field.</p>

<p>That’s it for the minimum configuration. There’s plenty more you can do if you need to but to get started that’s enough.</p>

<h4 id="application-usage">Application Usage</h4>

<p>Now that we have the configuration in place to use Guardian, we need to integrate it into the application. Since this is the minimum setup, let’s first consider HTTP requests.</p>

<h2 id="http-requests">HTTP requests</h2>

<p>Guardian provides a number of Plugs to facilitate integration into HTTP requests. You can learn about Plug in a <a href="../specifics/plug/">separate lesson</a>. Guardian doesn’t require Phoenix, but using Phoenix in the following examples will be easiest to demonstrate.</p>

<p>The easiest way to integrate into HTTP is via the router. Since Guardian’s HTTP integrations are all based on plugs, you can use these anywhere a plug could be used.</p>

<p>The general flow of Guardian plug is:</p>

<ol>
  <li>Find a token in the request (somewhere) and verify it: <code class="highlighter-rouge">Verify*</code> plugs</li>
  <li>Optionally load the resource identified in the token: <code class="highlighter-rouge">LoadResource</code> plug</li>
  <li>Ensure that there is a valid token for the request and refuse access if not. <code class="highlighter-rouge">EnsureAuthenticated</code> plug</li>
</ol>

<p>To meet all the needs of application developers, Guardian implements these phases separately. To find the token use the <code class="highlighter-rouge">Verify*</code> plugs.</p>

<p>Let’s create some pipelines.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">pipeline</span> <span class="ss">:maybe_browser_auth</span> <span class="k">do</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifySession</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">VerifyHeader</span><span class="p">,</span> <span class="ss">realm:</span> <span class="sd">"</span><span class="s2">Bearer"</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">LoadResource</span>
<span class="k">end</span>

<span class="n">pipeline</span> <span class="ss">:ensure_authed_access</span> <span class="k">do</span>
  <span class="n">plug</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="no">EnsureAuthenticated</span><span class="p">,</span> <span class="p">%{</span><span class="sd">"</span><span class="s2">typ"</span> <span class="o">=&gt;</span> <span class="sd">"</span><span class="s2">access"</span><span class="p">,</span> <span class="ss">handler:</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">HttpErrorHandler</span><span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>These pipelines can be used to compose different authentication requirements. The first pipeline tries to find a token first in the session and then falls back to a header. If it finds one, it will load the resource for you.</p>

<p>The second pipeline requires that there is a valid, verified token present and that it is of type “access”. To use these, add them to your scope.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">scope</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="no">MyApp</span> <span class="k">do</span>
  <span class="n">pipe_through</span> <span class="p">[</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:maybe_browser_auth</span><span class="p">]</span>
  
  <span class="n">get</span> <span class="sd">"</span><span class="s2">/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:new</span>
  <span class="n">post</span> <span class="sd">"</span><span class="s2">/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:create</span>
  <span class="n">delete</span> <span class="sd">"</span><span class="s2">/login"</span><span class="p">,</span> <span class="no">LoginController</span><span class="p">,</span> <span class="ss">:delete</span>
<span class="k">end</span>

<span class="n">scope</span> <span class="sd">"</span><span class="s2">/"</span><span class="p">,</span> <span class="no">MyApp</span> <span class="k">do</span>
  <span class="n">pipe_through</span> <span class="p">[</span><span class="ss">:browser</span><span class="p">,</span> <span class="ss">:maybe_browser_auth</span><span class="p">,</span> <span class="ss">:ensure_authed_access</span><span class="p">]</span>
  
  <span class="n">resource</span> <span class="sd">"</span><span class="s2">/protected/things"</span><span class="p">,</span> <span class="no">ProtectedController</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The login routes above will have the authenticated user if there is one. The second scope ensures that there is a valid token passed for all actions.<br />
You don’t <em>have</em> to put them in pipelines, you could put them in your controllers for super flexible customization but we’re doing a minimal setup.</p>

<p>We’re missing one piece so far. The error handler we added on the <code class="highlighter-rouge">EnsureAuthenticated</code> plug. This is a very simple module that responds to</p>

<ul>
  <li><code class="highlighter-rouge">unauthenticated/2</code></li>
  <li><code class="highlighter-rouge">unauthorized/2</code></li>
</ul>

<p>Both these functions receive a Plug.Conn struct and a params map and should handle their respective errors. You can even use a Phoenix controller!</p>

<h4 id="in-the-controller">In the controller</h4>

<p>Inside the controller, there are a couple of options for how to access the currently logged in user. Let’s start with the simplest.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>
  <span class="kn">use</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Phoenix</span><span class="o">.</span><span class="no">Controller</span>
  
  <span class="k">def</span> <span class="n">some_action</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">claims</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># do stuff</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>By using the <code class="highlighter-rouge">Guardian.Phoenix.Controller</code> module, your actions will receive two additional arguments that you can pattern match on. Remember, if you didn’t use <code class="highlighter-rouge">EnsureAuthenticated</code> you may have a nil user and claims.</p>

<p>The other - more flexible/verbose version - is to use plug helpers.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">MyController</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">MyApp</span><span class="o">.</span><span class="no">Web</span><span class="p">,</span> <span class="ss">:controller</span>
  
  <span class="k">def</span> <span class="n">some_action</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">authenticated?</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_resource</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="c1"># No user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h4 id="loginlogout">Login/Logout</h4>

<p>Logging in and out of a browser session is very simple. In your login controller:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">find_the_user_and_verify_them_from_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:access</span><span class="p">)</span> <span class="c1"># Use access tokens. Other tokens can be used, like :refresh etc</span>
      <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">()</span>
    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="c1"># handle not verifying the user's credentials</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">conn</span>
  <span class="o">|&gt;</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">sign_out</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">()</span>
<span class="k">end</span>
</code></pre>
</div>

<p>When using API login, it’s slightly different because there’s no session and you need to provide the raw token back to the client. <br />
For API login you’ll likely use the <code class="highlighter-rouge">Authorization</code> header to provide the token to your application. This method is useful when you do not intend on using a session.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">find_the_user_and_verify_them_from_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">jwt</span><span class="p">,</span> <span class="n">_claims</span><span class="p">}</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="n">encode_and_sign</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:access</span><span class="p">)</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">respond_somehow</span><span class="p">({</span><span class="ss">token:</span> <span class="n">jwt</span><span class="p">})</span>
    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">reason</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="c1"># handle not verifying the user's credentials</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="n">delete</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">jwt</span> <span class="o">=</span> <span class="no">Guardian</span><span class="o">.</span><span class="no">Plug</span><span class="o">.</span><span class="n">current_token</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
  <span class="no">Guardian</span><span class="o">.</span><span class="n">revoke!</span><span class="p">(</span><span class="n">jwt</span><span class="p">)</span>
  <span class="n">respond_somehow</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>The browser session login calls <code class="highlighter-rouge">encode_and_sign</code> under the hood so you can use them the same way.</p>


  

<hr />
<h3 id="social">
  
    Share This Page
  
</h3>
<div class="social__container">
  <div class="social__item">
    <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://elixirschool.com/lessons/libraries/guardian/&title=Guardian (Basics)&summary=description&source=https://elixirschool.com" class="social__icon--linkedin"><i class="icon--linkedin"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://twitter.com/intent/tweet?url=https://elixirschool.com/lessons/libraries/guardian/&via=elixirschool&text=ElixirSchool: Guardian (Basics)&hashtags=learnelixir%2Celixirlang&" class="social__icon--twitter"><i class="icon--twitter"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://plus.google.com/share?url=https://elixirschool.com/lessons/libraries/guardian/" class="social__icon--googleplus"><i class="icon--googleplus"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://elixirschool.com/lessons/libraries/guardian/" class="social__icon--facebook"><i class="icon--facebook"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.pinterest.com/pin/create/link/?url=https://elixirschool.com/lessons/libraries/guardian/&media=https://elixirschool.com/assets/fb_share.jpg&description=ElixirSchool: Guardian (Basics)" class="social__icon--pinterest"><i class="icon--pinterest"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://www.evernote.com/noteit.action?url=https://elixirschool.com/lessons/libraries/guardian/&title=ElixirSchool: Guardian (Basics)&suggestTags=elixir,programming" class="social__icon--evernote"><i class="icon--evernote"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="https://vk.com/share.php?url=https://elixirschool.com/lessons/libraries/guardian/&title=ElixirSchool: Guardian (Basics)&description=Check out 'Guardian (Basics)' on ElixirSchool" class="social__icon--vk" style="margin-left: 2px;"><i class="icon--vk"></i></a>
  </div>
  <div class="social__item">
    <a target="_blank" href="mailto:?&subject=ElixirSchool: Guardian (Basics)&body=Check out 'Guardian (Basics)' on ElixirSchool%0D%0A%0D%0Ahttps://elixirschool.com/lessons/libraries/guardian/" class="social__icon--email"><i class="icon--email"></i></a>
  </div>
  <div class="social__item">
    <a href="javascript:window.print()" class="social__icon--print"><i class="icon--print"></i></a>
  </div>
</div>
</div>
    </div>
  <script type="text/javascript" src="/assets/app.js"></script>
  </body>
</html>
